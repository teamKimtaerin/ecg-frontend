#!/bin/bash
# diff 파일 AI 분석 기반 PR 생성

DIFF_FILE="$1"
SUMMARY="$2"

if [ -z "$DIFF_FILE" ]; then
    echo "사용법: pr-diff <diff파일> [요약]"
    echo "예시: pr-diff changes.diff 'API 수정'"
    echo "  - diff파일: 분석할 변경사항 파일"
    echo "  - 요약: 작업 내용 한줄 요약 (선택)"
    exit 1
fi

if [ ! -f "$DIFF_FILE" ]; then
    echo "❌ diff 파일을 찾을 수 없습니다: $DIFF_FILE"
    exit 1
fi

echo "🔍 Claude AI로 diff 파일 분석 중..."
echo "📁 파일: $DIFF_FILE"

# diff 파일 내용 읽기
DIFF_CONTENT=$(cat "$DIFF_FILE")

# 변경된 파일들 추출
CHANGED_FILES=$(grep "^+++" "$DIFF_FILE" | sed 's/+++ b\///' | head -5 | tr '\n' ',' | sed 's/,$//')

# 추가된 라인 수
ADDED_LINES=$(grep "^+" "$DIFF_FILE" | grep -v "^+++" | wc -l)

# 삭제된 라인 수  
DELETED_LINES=$(grep "^-" "$DIFF_FILE" | grep -v "^---" | wc -l)

echo "📊 변경사항 요약:"
echo "  - 변경된 파일: $CHANGED_FILES"
echo "  - 추가된 라인: $ADDED_LINES"
echo "  - 삭제된 라인: $DELETED_LINES"

# AI 분석 프롬프트 생성 (Claude Code에서 실행시)
cat > /tmp/diff_analysis_prompt.txt << EOF
다음 diff 파일을 분석해서 PR 설명을 생성해주세요:

변경사항:
$DIFF_CONTENT

요구사항:
1. 어떤 기능이 추가/수정/삭제되었는지 구체적으로 분석
2. 코드 변경의 목적과 효과 파악  
3. 기술적 세부사항과 비즈니스 로직 변화 설명

PR 템플릿 형식으로 한글로 작성해주세요.
EOF

echo ""
echo "🤖 Claude AI 분석을 위한 프롬프트가 생성되었습니다."
echo "📋 다음 명령어로 Claude에게 분석을 요청하세요:"
echo ""
echo "claude < /tmp/diff_analysis_prompt.txt"
echo ""
echo "또는 Claude Code에서 다음 내용을 복사해서 분석 요청:"
echo "----------------------------------------"
cat /tmp/diff_analysis_prompt.txt
echo "----------------------------------------"

# 기본 PR 템플릿도 생성
TITLE="[FEAT] $(basename "$DIFF_FILE" .diff) 변경사항 반영"
[ -n "$SUMMARY" ] && TITLE="[FEAT] $SUMMARY"

BODY="## 개요
- diff 파일 기반 코드 변경사항을 분석하여 적용했습니다
- 주요 변경 파일: $CHANGED_FILES  
- 변경 규모: +$ADDED_LINES/-$DELETED_LINES lines
$([ -n "$SUMMARY" ] && echo "- 작업 내용: $SUMMARY")

## 설명

### What
- 제공된 diff 파일의 변경사항을 체계적으로 반영했습니다
- 총 $(echo $CHANGED_FILES | tr ',' '\n' | wc -l)개 파일이 수정되었습니다

### Why  
- 요구사항에 따른 기능 개선 및 코드 품질 향상이 필요했습니다
- diff 파일에 명시된 변경사항을 통해 시스템을 개선했습니다

### How
- diff 파일을 상세히 분석하여 각 변경사항의 목적을 파악했습니다
- 기존 코드와의 호환성을 고려하며 안전하게 적용했습니다
- 변경사항에 대한 충분한 테스트를 진행했습니다

## 참고
$([ -n "$ISSUE" ] && echo "- 관련 이슈: #$ISSUE")
- diff 파일: $DIFF_FILE
- 변경 통계: +$ADDED_LINES additions, -$DELETED_LINES deletions
- AI 분석 요청을 통해 더 상세한 설명을 얻을 수 있습니다"

echo ""
echo "📄 기본 PR 템플릿 미리보기:"
echo "제목: $TITLE"
echo ""
echo "$BODY"

# 사용자에게 선택권 제공
echo ""
echo "🔄 다음 중 선택하세요:"
echo "1. 기본 템플릿으로 PR 생성"
echo "2. Claude AI 분석 후 수동으로 PR 생성"
echo "3. 취소"

read -p "선택 (1-3): " choice

case $choice in
    1)
        echo "🚀 기본 템플릿으로 PR 생성 중..."
        BRANCH=$(git branch --show-current)
        MAIN=$(git remote show origin | grep "HEAD branch" | cut -d' ' -f5)
        
        gh pr create \
            --title "$TITLE" \
            --body "$BODY" \
            --base "$MAIN" \
            --head "$BRANCH"
        
        echo "✅ PR 생성 완료!"
        gh pr view --web
        ;;
    2)
        echo "🤖 Claude AI 분석을 진행해주세요."
        echo "분석 완료 후 수동으로 PR을 생성하시면 됩니다."
        ;;
    3)
        echo "❌ 취소되었습니다."
        ;;
    *)
        echo "❌ 잘못된 선택입니다."
        ;;
esac

# 임시 파일 정리
rm -f /tmp/diff_analysis_prompt.txt